<!DOCTYPE html>
<html lang="mn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JKM Trading AI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
    rel="stylesheet">
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    :root {
      --bg-start: #f3f5ff;
      --bg-end: #ffffff;
      --text: #102043;
      --muted: #5c6782;
      --accent: #3b7bff;
      --accent-dark: #2651ff;
      --border: #e5e9ff;
      --card: #ffffff;
      --shadow: 0 20px 45px rgba(17, 37, 94, 0.08);
      --radius-lg: 28px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(145deg, var(--bg-start), var(--bg-end));
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .muted {
      color: var(--muted);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      font-family: inherit;
    }

    .site-header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(16px);
      background: rgba(243, 245, 255, 0.82);
      border-bottom: 1px solid rgba(229, 233, 255, 0.8);
      padding: 18px 5vw;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-pill {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px 18px;
      border-radius: 999px;
      background: #0d1a3f;
      color: #fff;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .logo-pill small {
      font-size: 11px;
      opacity: 0.75;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .main-nav {
      display: flex;
      gap: 24px;
      font-weight: 500;
      font-size: 14px;
    }

    .nav-public,
    .nav-auth {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .nav-auth {
      display: none;
      gap: 24px;
    }

    .nav-link {
      color: var(--muted);
    }

    .nav-link:hover {
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .language-toggle {
      display: inline-flex;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px;
    }

    .language-toggle button {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 4px 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
    }

    .language-toggle button.active {
      background: var(--accent);
      color: #fff;
    }

    .ghost-btn,
    .primary-btn {
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 600;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
    }

    .primary-btn {
      border: none;
      background: linear-gradient(120deg, var(--accent), var(--accent-dark));
      color: #fff;
      box-shadow: 0 18px 30px rgba(59, 123, 255, 0.35);
    }

    .ghost-btn:focus,
    .primary-btn:focus,
    .nav-link:focus,
    .language-toggle button:focus,
    .form-field input:focus,
    .form-field textarea:focus,
    .form-field select:focus {
      outline: 2px solid rgba(59, 123, 255, 0.35);
      outline-offset: 2px;
    }

    .account-pill {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(59, 123, 255, 0.2);
      background: rgba(255, 255, 255, 0.9);
    }

    main.landing {
      max-width: 1200px;
      margin: 0 auto;
      padding: 64px clamp(18px, 5vw, 56px) 40px;
    }

    section[id],
    main[id] {
      scroll-margin-top: 120px;
    }

    .hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 40px;
      align-items: center;
      margin-bottom: 80px;
    }

    .hero label {
      font-size: 12px;
      letter-spacing: 0.28em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .hero h1 {
      font-size: clamp(32px, 4vw, 52px);
      margin: 16px 0 8px;
      font-family: 'Space Grotesk', sans-serif;
      line-height: 1.15;
    }

    .hero h4 {
      margin: 0 0 20px;
      color: var(--muted);
      font-weight: 500;
    }

    .hero p {
      margin-bottom: 20px;
      max-width: 520px;
    }

    .hero ul {
      list-style: none;
      padding: 0;
      margin: 0 0 28px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cta-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .hero-visual {
      padding: 28px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: var(--shadow);
    }

    .mini-dashboard {
      border-radius: 22px;
      border: 1px solid #dfe5ff;
      padding: 18px;
      background: linear-gradient(145deg, #f7f8ff, #fff);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mini-dashboard .chart-preview {
      border-radius: 18px;
      border: 1px dashed #cfd7ff;
      height: 180px;
      background: repeating-linear-gradient(120deg, rgba(59, 123, 255, 0.15), rgba(59, 123, 255, 0.15) 12px, transparent 12px, transparent 24px);
      position: relative;
      overflow: hidden;
    }

    .mini-dashboard .chart-preview::after {
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.7);
    }

    .section {
      margin-bottom: 80px;
    }

    .section h2 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .section h4 {
      margin-top: 0;
      color: var(--muted);
      font-weight: 500;
    }

    .feature-grid,
    .steps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }

    .feature-card,
    .step-card,
    .contact-card,
    .auth-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .feature-card h3,
    .step-card h3 {
      margin-top: 12px;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .step-card span {
      font-weight: 700;
      color: var(--accent);
    }

    .auth-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 28px;
      align-items: stretch;
    }

    .auth-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .auth-tabs button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f6f8ff;
      padding: 10px 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
    }

    .auth-tabs button.active {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
      font-size: 14px;
      color: var(--muted);
    }

    .form-field input,
    .form-field textarea,
    .form-field select {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      font-size: 14px;
      color: var(--text);
      background: #fdfdff;
    }

    .form-field select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 38px;
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .contact-card .contact-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }

    .contact-card button {
      width: 100%;
      margin-top: 24px;
      padding: 14px;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .site-footer {
      text-align: center;
      padding: 32px 20px 40px;
      color: var(--muted);
      font-size: 13px;
    }

    .site-footer nav {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .dashboard-app {
      display: none;
      padding: 40px 5vw 80px;
    }

    body.auth-mode main.landing,
    body.auth-mode .site-footer {
      display: none;
    }

    body.auth-mode .dashboard-app {
      display: block;
      background: radial-gradient(circle at top, #f4f7ff, #fdfdff 45%, #ffffff 100%);
    }

    body.auth-mode .nav-public {
      display: none;
    }

    body.auth-mode .nav-auth {
      display: flex;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    body.auth-mode .auth-buttons {
      display: none;
    }

    body.auth-mode .account-pill {
      display: inline-flex;
    }

    .dashboard-shell {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .dashboard-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .dash-card {
      background: #0d1b34;
      color: #fff;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 30px 60px rgba(13, 27, 52, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .dash-card.light {
      background: #ffffff;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    #tv_chart {
      height: 360px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.06);
    }

    .chart-fallback {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 18px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.75);
    }

    .chart-fallback strong {
      color: #fff;
    }

    .chart-controls {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chart-controls button {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      cursor: pointer;
    }

    .chart-controls button.active {
      background: #fff;
      color: #0d1b34;
    }

    .profile-stack {
      background: #f6f8ff;
      border-radius: 22px;
      border: 1px solid var(--border);
      padding: 18px;
      margin-top: 16px;
    }

    .admin-inline {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .admin-inline input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
    }

    .admin-inline button {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }

    #profilesList {
      display: none;
      margin-top: 12px;
      flex-direction: column;
      gap: 8px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      background: #fff;
      font-size: 13px;
    }

    .admin-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(59, 123, 255, 0.25);
      background: rgba(59, 123, 255, 0.12);
      color: var(--accent);
      font-weight: 700;
      font-size: 12px;
    }

    .stats-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 12px;
      padding: 14px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: #f6f8ff;
      font-size: 13px;
      color: var(--text);
    }

    .stats-grid span:nth-child(2n) {
      color: var(--muted);
    }

    .metric-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: stretch;
    }

    .auth-toast {
      font-size: 13px;
      min-height: 18px;
      color: var(--accent);
      margin-top: 8px;
    }

    @media (max-width: 960px) {
      .site-header {
        flex-direction: column;
        gap: 16px;
      }
    }

    @media (max-width: 640px) {
      .cta-group {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions {
        flex-direction: column;
      }

      .language-toggle,
      .auth-buttons,
      .account-pill {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="logo-pill">
      <span id="brandTitle">JKM Trading AI</span>
      <small id="brandTagline">Automation Desk</small>
    </div>
    <nav class="main-nav">
      <div class="nav-public">
        <a id="navHome" class="nav-link" href="#home">–ù“Ø“Ø—Ä</a>
        <a id="navFeatures" class="nav-link" href="#features">–û–Ω—Ü–ª–æ–≥</a>
        <a id="navHow" class="nav-link" href="#how-it-works">–Ø–∞–∂ –∞–∂–∏–ª–ª–∞–¥–∞–≥ –≤—ç?</a>
        <a id="navPricing" class="nav-link" href="#auth">“Æ–Ω—ç —Ç”©–ª–±”©—Ä</a>
        <a id="navContact" class="nav-link" href="#contact">–•–æ–ª–±–æ–æ –±–∞—Ä–∏—Ö</a>
      </div>
      <div class="nav-auth">
        <a id="navDashboard" class="nav-link" href="#dashTop">–°–∞–º–±–∞—Ä</a>
        <a id="navApproach" class="nav-link" href="#dashControls">–ê—Ä–≥–∞ –±–∞—Ä–∏–ª</a>
        <a id="navStrategy" class="nav-link" href="#dashSignals">–°—Ç—Ä–∞—Ç–µ–≥–∏</a>
        <a id="navSettings" class="nav-link" href="#dashMetrics">–¢–æ—Ö–∏—Ä–≥–æ–æ</a>
        <a id="navChartBoard" class="nav-link" href="/chartboard">ChartBoard</a>
      </div>
    </nav>
    <div class="header-actions">
      <div class="language-toggle">
        <button class="active" data-lang="mn">MN</button>
        <button data-lang="en">EN</button>
      </div>
      <div class="auth-buttons">
        <button id="headerLogin" class="ghost-btn" data-scroll="#auth">–ù—ç–≤—Ç—Ä—ç—Ö</button>
        <button id="headerRegister" class="primary-btn" data-scroll="#auth">–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö</button>
      </div>
      <div class="account-pill">
        <div>
          <strong id="accountName">Ganbayar</strong>
          <div id="accountRole" style="font-size:12px; color:var(--muted);">Admin</div>
        </div>
        <button id="headerLogout" class="ghost-btn" style="padding:6px 12px;" onclick="logoutUser()">Log out</button>
      </div>
    </div>
  </header>

  <main class="landing" id="home">
    <section class="hero" id="hero">
      <div class="hero__text">
        <label id="heroLabel">TRADING AUTOMATION ‚Ä¢ 24/7 SCAN</label>
        <h1 id="heroTitle">–¢–∞–Ω—ã –∞—Ä–∏–ª–∂–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª—ã–≥ 24/7 —Å–∫–∞–Ω —Ö–∏–π–¥—ç–≥ AI —Ç—É—Å–ª–∞—Ö.</h1>
        <h4 id="heroSubtitle">An AI trading assistant that scans the markets with your own strategy.</h4>
        <p id="heroDesc">JKM AI –Ω—å trader —Ö“Ø–Ω–∏–π ”©–¥”©—Ä —Ç—É—Ç–º—ã–Ω –∞–∂–ª—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∂—É—É–ª–∞—Ö–∞–¥ –∑–æ—Ä–∏—É–ª–∞–≥–¥—Å–∞–Ω. STR –ø—Ä–æ—Ñ–∞–π–ª–¥–∞–∞ –Ω—ç–≥ —É–¥–∞–∞
          –¥“Ø—Ä–º—ç—ç –æ—Ä—É—É–ª–∞–∞–¥, IG Markets API-–≥–∞–∞—Ä —Ç–∞—Å—Ä–∞–ª—Ç–≥“Ø–π —Ö—è–Ω–∞–ª—Ç —Ç–∞–≤—å–∂, —Ç–æ—Ö–∏—Ä—Å–æ–Ω setup –∏–ª—Ä—ç—Ö –º”©—á–∏–¥ Telegram –¥—ç—ç—Ä
          –º–æ–Ω–≥–æ–ª–æ–æ—Ä —Ç–∞–π–ª–±–∞—Ä—Ç–∞–π —Å–∏–≥–Ω–∞–ª –∏—Ä–Ω—ç.</p>
        <ul>
          <li id="heroBullet1">‚Ä¢ 24/7 –∞–≤—Ç–æ–º–∞—Ç —Å–∫–∞–Ω ‚Äì –∑–∞—Ö –∑—ç—ç–ª —É–Ω—Ç–∞—Ö–≥“Ø–π, —Ö–∞—Ä–∏–Ω —Ç–∞ –∞–º–∞—Ä—á –±–æ–ª–Ω–æ</li>
          <li id="heroBullet2">‚Ä¢ –¢–∞–Ω—ã ”©”©—Ä–∏–π–Ω –∞—Ä–≥–∞ –±–∞—Ä–∏–ª ‚Äì random —Å–∏–≥–Ω–∞–ª –±–∏—à, —Ç–∞–Ω—ã –¥“Ø—Ä–º—ç—ç—Ä</li>
          <li id="heroBullet3">‚Ä¢ –≠–º–æ—Ü–∏–≥“Ø–π, —Å–∏—Å—Ç–µ–º—Ç—ç–π —à–∏–π–¥–≤—ç—Ä –≥–∞—Ä–≥–∞–ª—Ç</li>
        </ul>
        <div class="cta-group">
          <button id="heroCtaTelegram" class="primary-btn" data-scroll="#contact">Telegram bot-–æ–æ—Ä —Ç—É—Ä—à–∏–∂ “Ø–∑—ç—Ö</button>
          <button id="heroCtaRegister" class="ghost-btn" data-scroll="#auth">“Æ–Ω—ç–≥“Ø–π –±“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö</button>
        </div>
      </div>
      <div class="hero-visual">
        <div class="mini-dashboard">
          <div>
            <small style="color:var(--muted);">XAUUSD ‚Äì Manual analysis</small>
            <h3 style="margin:6px 0 0;">BUY bias ‚Ä¢ RR 1:3</h3>
          </div>
          <div class="chart-preview"></div>
          <div style="font-size:14px; color:var(--muted);">
            –°“Ø“Ø–ª–¥ –∏–ª–≥—ç—ç—Å—ç–Ω —Å–∏–≥–Ω–∞–ª:<br>
            <strong>BUY @ 2312.50</strong> ‚Ä¢ SL 2300 ‚Ä¢ TP 2345 ‚Ä¢ Telegram –¥—ç—ç—Ä chart + —Ç–∞–π–ª–±–∞—Ä
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="features">
      <h2 id="featuresTitle">–¢—Ä–µ–π–¥–µ—Ä —Ö“Ø–Ω–¥ JKM AI —è–º–∞—Ä —Ö—ç—Ä—ç–≥—Ç—ç–π –≤—ç?</h2>
      <h4 id="featuresSubtitle">Why traders use JKM AI</h4>
      <div class="feature-grid">
        <article class="feature-card">
          <strong>01</strong>
          <h3>–¶–∞–≥ —Ö—ç–º–Ω—ç–ª—Ç / Time-saving</h3>
          <p>–ó–∞—Ö –∑—ç—ç–ª 24/7 –Ω—ç—ç–ª—Ç—Ç—ç–π —á —Ç–∞ –±“Ø—Ç—ç–Ω ”©–¥”©—Ä–∂–∏–Ω–≥”©”© chart —Ö–∞—Ä–∂ —Å—É—É—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π. Bot –Ω—å —Ö—ç–¥—ç–Ω –∞—Ä–≤–∞–Ω —Ö–æ—Å—ã–≥ —Ç–∞–Ω–¥
            ”©”©—Ä–∏–π–Ω –¥“Ø—Ä–º—ç—ç—Ä —à“Ø“Ø–Ω –º—ç–¥—ç–≥–¥—ç–Ω—ç.</p>
        </article>
        <article class="feature-card">
          <strong>02</strong>
          <h3>–î“Ø—Ä—ç–º—Ç –∞—Ä–∏–ª–∂–∞–∞ / Rule-based trading</h3>
          <p>STR –ø—Ä–æ—Ñ–∞–π–ª –¥—ç—ç—Ä—ç—ç trend TF, entry TF, min RR, fibo –±“Ø—Å –∑—ç—Ä—ç–≥ —à–∞–∞—Ä–¥–ª–∞–≥–∞–∞ –Ω—ç–≥ —É–¥–∞–∞ —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞. AI –Ω—å
            —ç–¥–≥—ç—ç—Ä–∏–π–≥ –∑”©—Ä—á–∏–ª–≥“Ø–π –º”©—Ä–¥”©–Ω”©.</p>
        </article>
        <article class="feature-card">
          <strong>03</strong>
          <h3>–Ø—Å —Ç–∞–π–ª–±–∞—Ä–ª–∞—Å–∞–Ω –∞–Ω–∞–ª–∏–∑ / Clear analysis</h3>
          <p>–°–∏–≥–Ω–∞–ª –±“Ø—Ä—Ç—ç–π —Ö–∞–º—Ç –æ–ª–æ–Ω timeframe-–∏–π–Ω —Ç–æ–≤—á –¥“Ø–≥–Ω—ç–ª—Ç, chart screenshot, —è–∞–≥–∞–∞–¥ setup –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥
            —Ç–∞–π–ª–±–∞—Ä–ª–∞—Å–∞–Ω —Ç–µ–∫—Å—Ç –¥–∞–≥–∞–ª–¥–∞–Ω–∞.</p>
        </article>
        <article class="feature-card">
          <strong>04</strong>
          <h3>Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü / Telegram-first</h3>
          <p>–ó”©–≤—Ö”©–Ω Telegram –∞—à–∏–≥–ª–∞–∞–¥ —Å–∏–≥–Ω–∞–ª, –ø—Ä–æ—Ñ–∞–π–ª, –∫–æ–º–∞–Ω–¥—É—É–¥–∞–∞ —É–¥–∏—Ä–¥–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π. –•“Ø—Å–≤—ç–ª –≤—ç–± –¥—ç—ç—Ä—ç—ç—Å –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π
            —Å–∞–º–±–∞—Ä —Ä—É—É –Ω—ç–≤—Ç—ç—Ä–Ω—ç.</p>
        </article>
      </div>
    </section>

    <section class="section" id="how-it-works">
      <h2 id="howTitle">–Ø–∞–∂ –∞–∂–∏–ª–ª–∞–¥–∞–≥ –≤—ç?</h2>
      <h4 id="howSubtitle">4 –∞–ª—Ö–∞–º—Ç –∞–≤—Ç–æ–º–∞—Ç–∂—É—É–ª–∞–ª—Ç</h4>
      <div class="steps-grid">
        <article class="step-card">
          <span>1</span>
          <h3>–ü—Ä–æ—Ñ–∞–π–ª “Ø“Ø—Å–≥—ç—Ö</h3>
          <p>–ù—ç—Ä, –∞—Ä–≥–∞ –±–∞—Ä–∏–ª, min RR, risk %, timeframe –≥—ç—Ö –º—ç—Ç STR –º—ç–¥—ç—ç–ª–ª—ç—ç –æ—Ä—É—É–ª–∞–∞–¥ JSON –ø—Ä–æ—Ñ–∞–π–ª –±–æ–ª–≥–æ–∂ —Ö–∞–¥–≥–∞–ª—É—É–ª–Ω–∞.
          </p>
        </article>
        <article class="step-card">
          <span>2</span>
          <h3>–ê—Ä–≥–∞ –±–∞—Ä–∏–ª–∞–∞ AI-–¥ –æ–π–ª–≥—É—É–ª–Ω–∞</h3>
          <p>STR —Ç–µ–∫—Å—Ç, –∂–∏—à—ç—ç –∑—É—Ä–≥–∞–∞—Å AI “Ø–Ω–¥—Å—ç–Ω –¥“Ø—Ä–º–∏–π–≥ –≥–∞—Ä–≥–∞–∂, trend, entry, SL/TP —Ç–∞–≤–∏—Ö –ª–æ–≥–∏–∫–∏–π–≥ –æ–π–ª–≥–æ–∂ –∞–≤–Ω–∞.</p>
        </article>
        <article class="step-card">
          <span>3</span>
          <h3>24/7 –∑–∞—Ö –∑—ç—ç–ª —Å–∫–∞–Ω</h3>
          <p>IG Markets API-–≥–∞–∞—Ä D1, H4, H1, M15 timeframe –ª–∞–∞–Ω—É—É–¥—ã–≥ —Ç–∞—Ç–∞–∂ engine_blocks –¥—ç—ç—Ä —à“Ø“Ø–∂ —Ç–æ—Ö–∏—Ä–æ—Ö setup —Ö–∞–π–Ω–∞.
          </p>
        </article>
        <article class="step-card">
          <span>4</span>
          <h3>–°–∏–≥–Ω–∞–ª –∞–≤—á —à–∏–π–¥–≤—ç—Ä –≥–∞—Ä–≥–∞–Ω–∞</h3>
          <p>Setup –∏–ª—ç—Ä–≤—ç–ª Telegram –¥—ç—ç—Ä –º–æ–Ω–≥–æ–ª–æ–æ—Ä —Ç–∞–π–ª–±–∞—Ä—Ç–∞–π —Å–∏–≥–Ω–∞–ª –∏—Ä–∂, —Ç–∞ —Ö“Ø–Ω–∏–π —à–∏–π–¥–≤—ç—Ä—ç—ç –Ω—ç–º—ç—ç–¥ –∞—Ä–∏–ª–∂–∞–∞ —Ö–∏–π–Ω—ç.</p>
        </article>
      </div>
    </section>

    <section class="section auth-grid" id="auth">
      <article class="auth-card">
        <div class="auth-tabs">
          <button id="loginTab" class="active" onclick="setActiveAuthTab('login')">–ù—ç–≤—Ç—Ä—ç—Ö / Login</button>
          <button id="registerTab" onclick="setActiveAuthTab('register')">–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö / Register</button>
        </div>
        <form id="loginForm" onsubmit="handleAuthSubmit(event, 'login')">
          <div class="form-field">
            <label id="loginEmailLabel">–ò–º—ç–π–ª / Email</label>
            <input id="loginEmail" type="email" placeholder="name@example.com" required>
          </div>
          <div class="form-field">
            <label id="loginPasswordLabel">–ù—É—É—Ü “Ø–≥ / Password</label>
            <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>
          <div class="form-footer">
            <label style="display:flex; gap:6px; align-items:center;">
              <input type="checkbox" checked>
              <span id="loginRemember">–°–∏—Å—Ç–µ–º–¥ –Ω—ç–≤—Ç—ç—Ä—Å—ç–Ω —Ö—ç–≤—ç—ç—Ä –±–∞–π—è</span>
            </label>
            <a id="loginForgot" href="#">–ù—É—É—Ü “Ø–≥ –º–∞—Ä—Ç—Å–∞–Ω?</a>
          </div>
          <button id="loginSubmit" class="primary-btn" type="submit" style="width:100%;">–ù—ç–≤—Ç—Ä—ç—Ö / Sign in</button>
        </form>
        <form id="registerForm" style="display:none;" onsubmit="handleAuthSubmit(event, 'register')">
          <div class="form-field">
            <label id="registerNameLabel">–ù—ç—Ä / Full name</label>
            <input id="registerName" type="text" placeholder="Ganbayar" required>
          </div>
          <div class="form-field">
            <label id="registerEmailLabel">–ò–º—ç–π–ª / Email</label>
            <input id="registerEmail" type="email" placeholder="name@example.com" required>
          </div>
          <div class="form-field">
            <label id="registerPasswordLabel">–ù—É—É—Ü “Ø–≥ / Password</label>
            <input id="registerPassword" type="password" required>
          </div>
          <div class="form-field">
            <label id="registerConfirmLabel">–ù—É—É—Ü “Ø–≥ –¥–∞–≤—Ç–∞—Ö / Confirm password</label>
            <input id="registerPasswordConfirm" type="password" required>
          </div>
          <label id="registerTerms"
            style="display:flex; gap:6px; font-size:13px; color:var(--muted); margin-bottom:16px;">
            <input type="checkbox" required>
            “Æ–π–ª—á–∏–ª–≥—ç—ç–Ω–∏–π –Ω”©—Ö—Ü”©–ª –∑”©–≤—à”©”©—Ä—á –±–∞–π–Ω–∞
          </label>
          <button id="registerSubmit" class="primary-btn" type="submit" style="width:100%;">–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö / Create
            account</button>

          <div id="registerVerifySection" style="display:none; margin-top:14px; padding-top:14px; border-top:1px solid var(--border);">
            <div class="form-field">
              <label id="verifyCodeLabel">Verify –∫–æ–¥ (6 –æ—Ä–æ–Ω—Ç–æ–π)</label>
              <input id="verifyCode" type="text" inputmode="numeric" autocomplete="one-time-code" placeholder="123456">
            </div>
            <button id="verifyCodeSubmit" class="primary-btn" type="button" style="width:100%;">–ö–æ–¥–æ–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö</button>
            <button id="registerResendVerify" class="ghost-btn" type="button" style="width:100%; margin-top:10px;">Verify –∏–º—ç–π–ª –¥–∞—Ö–∏–Ω —è–≤—É—É–ª–∞—Ö</button>
          </div>
        </form>
        <div id="authStatus" class="auth-toast"></div>
      </article>
      <article class="contact-card" id="contact">
        <h3 id="contactTitle">Telegram –¥—ç—ç—Ä—ç—ç—Å —à—É—É–¥ —Ç—É—Ä—à–∏–∂ “Ø–∑—ç—Ö</h3>
        <p id="contactDesc">JKM Trading AI bot-—ã–≥ Telegram –¥—ç—ç—Ä—ç—ç—Å —à—É—É–¥ —ç—Ö–ª“Ø“Ø–ª—ç—ç–¥ demo account –¥—ç—ç—Ä —Å–∏–≥–Ω–∞–ª —Ç—É—Ä—à–∞–∞—Ä–∞–π.
          –ê—Å—É—É–ª—Ç –±–∞–π–≤–∞–ª —á–∞—Ç –±–∏—á–∏—Ö—ç–¥ —Ö–∞–Ω–≥–∞–ª—Ç—Ç–∞–π.</p>
        <div class="contact-row"><span id="contactTelegramLabel">Telegram:</span> <a id="contactTelegram" href="#"
            target="_blank">@your_username</a></div>
        <div class="contact-row"><span id="contactEmailLabel">Email:</span> <a id="contactEmail"
            href="mailto:support@yourdomain.com">support@yourdomain.com</a></div>
        <button id="contactButton" class="primary-btn">Start Telegram Bot</button>
        <p id="contactHint" style="font-size:13px; color:var(--muted); text-align:center;">–ù—ç—ç—Ö—ç–¥ Telegram app
          –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞–∂–∏–ª–ª–∞–Ω–∞.</p>
      </article>
    </section>
  </main>

  <section id="dashboardApp" class="dashboard-app">
    <div class="dashboard-shell">
      <div id="dashTop" class="dashboard-topbar">
        <div>
          <p style="letter-spacing:0.2em; font-size:12px; color:var(--muted); text-transform:uppercase; margin:0;">Live
            control</p>
          <h2 style="margin:4px 0 0;">JKM AI Dashboard</h2>
        </div>
      </div>
      <div class="dashboard-grid">
        <article id="dashControls" class="dash-card light">
          <div>
            <p style="text-transform:uppercase; letter-spacing:0.2em; font-size:12px; color:var(--muted); margin:0;">
              Manual analysis</p>
            <h3 style="margin:6px 0 0;">–•–æ—Å–ª–æ–ª —É–¥–∏—Ä–¥–ª–∞–≥–∞</h3>
          </div>
          <label class="form-field" style="margin-top:16px;">
            <span>–ê–Ω–∞–ª–∏–∑ —Ö–∏–π—Ö —Ö–æ—Å / Pair</span>
            <select id="pairSelect">
              <option value="XAUUSD">XAUUSD</option>
              <option value="USDJPY">USDJPY</option>
              <option value="GBPJPY">GBPJPY</option>
              <option value="USDCHF">USDCHF</option>
              <option value="NAS100">NAS100</option>
              <option value="SP500">SP500</option>
              <option value="BITCOIN">BITCOIN</option>
            </select>
          </label>
          <p id="profileSummary" style="min-height:20px; font-size:14px; color:var(--muted);"></p>
          <div id="setupStats" class="stats-grid">
            <span>–°—Ç–∞—Ç—É—Å</span><span>–°–µ—Ç–∞–ø –∏–ª—Ä—ç—ç–≥“Ø–π</span>
            <span>–•–æ—Å</span><span>‚Äî</span>
            <span>Entry / SL / TP</span><span>‚Äî</span>
            <span>RR</span><span>‚Äî</span>
          </div>
          <div style="font-size:12px; color:var(--muted);">–°“Ø“Ø–ª–¥ —à–∏–Ω—ç—á–ª—ç–≥–¥—Å—ç–Ω: <span id="setupUpdatedAt">‚Äî</span></div>
          <div class="cta-group" style="margin-top:16px;">
            <button class="primary-btn" onclick="refreshStr()">STR —à–∏–Ω–∂–∏–ª–≥—ç—ç</button>
            <button class="ghost-btn" onclick="refreshTech()">–¢–µ—Ö–Ω–∏–∫ —à–∏–Ω–∂–∏–ª–≥—ç—ç</button>
            <button class="ghost-btn" onclick="refreshMacro()">–ú–∞–∫—Ä–æ —à–∏–Ω–∂–∏–ª–≥—ç—ç</button>
          </div>
          <div class="profile-stack">
            <strong>–ü—Ä–æ—Ñ–∞–π–ª —É–¥–∏—Ä–¥–ª–∞–≥–∞</strong>
            <div class="admin-inline" id="adminBanner">
              <span id="adminStatus" class="admin-pill" style="display:none;">–ê–¥–º–∏–Ω –≥–æ—Ä–∏–º</span>
              <span id="adminHint" style="font-size:13px; color:var(--muted);">–ê–¥–º–∏–Ω —ç—Ä—Ö—Ç—ç–π —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ –±“Ø—Ö –ø—Ä–æ—Ñ–∞–π–ª—ã–≥
                —É–¥–∏—Ä–¥–∞–Ω–∞.</span>
            </div>
            <form id="profileForm" style="display:none;">
              <div class="form-field">
                <label>–ü—Ä–æ—Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä</label>
                <input type="text" id="profileName" placeholder="XAUUSD breakout">
              </div>
              <div class="form-field">
                <label>–¢—ç–º–¥—ç–≥–ª—ç–ª (Risk/Strategy)</label>
                <input type="text" id="profileNote" placeholder="RR, –æ—Ä–æ–ª—Ç—ã–Ω –¥“Ø—Ä—ç–º">
              </div>
              <div class="form-field">
                <label>Timezone (UTC offset)</label>
                <input type="number" id="profileTzOffset" placeholder="8" min="-12" max="14" step="1">
              </div>
              <button type="button" class="primary-btn" style="width:100%;" onclick="saveProfile()">–ü—Ä–æ—Ñ–∞–π–ª
                —Ö–∞–¥–≥–∞–ª–∞—Ö</button>
            </form>
            <div id="profilesList"></div>
            <div id="validationMsg" class="auth-toast"></div>
            <div id="traderTip" style="font-size:12px; color:var(--muted);">AI —Ç–∞–π–ª–±–∞—Ä –Ω—å —Ö“Ø–Ω–∏–π —à–∏–π–¥–≤—ç—Ä–∏–π–≥ —Å–æ–ª–∏—Ö–≥“Ø–π.
              Risk –º–µ–Ω–µ–∂–º–µ–Ω—Ç—ç—ç “Ø—Ä–≥—ç–ª–∂ –º”©—Ä–¥”©”©—Ä—ç–π.</div>
          </div>
        </article>
        <article id="dashChart" class="dash-card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <p
                style="letter-spacing:0.2em; font-size:12px; text-transform:uppercase; margin:0; color:rgba(255,255,255,0.7);">
                Live chart</p>
              <h3>IG Streaming Chart</h3>
            </div>
            <span style="font-size:12px; color:rgba(255,255,255,0.7);">–°“Ø“Ø–ª–¥ —à–∏–Ω—ç—á–ª—ç–≥–¥—Å—ç–Ω: <strong
                id="lastUpdateLabel">‚Äî</strong></span>
          </div>
          <div id="tv_chart"></div>
          <div class="chart-controls">
            <span style="color:rgba(255,255,255,0.7);">Timeframe:</span>
            <button type="button" class="active" data-resolution="15"
              onclick="setChartResolution('15', this)">15–ú</button>
            <button type="button" data-resolution="60" onclick="setChartResolution('60', this)">1–¶</button>
            <button type="button" data-resolution="240" onclick="setChartResolution('240', this)">4–¶</button>
            <button type="button" data-resolution="D" onclick="setChartResolution('D', this)">”®–¥”©—Ä</button>
          </div>
          <p style="font-size:12px; color:rgba(255,255,255,0.7);">IG mid price-—Ç—ç–π —É—è–ª–¥—Å–∞–Ω —Ç—É–ª –≥—Ä–∞—Ñ–∏–∫ –Ω—å –∑”©–≤—Ö”©–Ω
            —à–∏–π–¥–≤—ç—Ä–∏–π–Ω reference –∑–æ—Ä–∏–ª–≥–æ–æ—Ä –∞—à–∏–≥–ª–∞–≥–¥–∞–Ω–∞.</p>
        </article>
        <article id="dashSignals" class="dash-card light">
          <div>
            <p style="letter-spacing:0.2em; font-size:12px; text-transform:uppercase; color:var(--muted); margin:0;">
              Trading signals</p>
            <h3>AI —Ç–∞–π–ª–±–∞—Ä</h3>
          </div>
          <pre id="aiOutput"
            style="white-space:pre-wrap; font-family:'Inter',sans-serif; font-size:14px; background:#f6f8ff; padding:16px; border-radius:18px; border:1px solid var(--border); min-height:220px;">–•–æ—Å–æ–æ —Å–æ–Ω–≥–æ–æ–¥ —à–∏–Ω–∂–∏–ª–≥—ç—ç–≥ –∞–∂–∏–ª–ª—É—É–ª–Ω–∞ —É—É.</pre>
          <ul
            style="list-style:none; padding:0; margin:16px 0 0; color:var(--muted); font-size:13px; display:flex; flex-direction:column; gap:8px;">
            <li>‚ö° STR —à–∞–ª–≥—É—É—Ä –±–∏–µ–ª—Å—ç–Ω —ç—Å—ç—Ö</li>
            <li>üéØ RR 2.0-–∞–∞—Å –¥—ç—ç—à —ç—Å—ç—Ö</li>
            <li>üõ°Ô∏è Risk free –±–æ–ª–æ–º–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö</li>
            <li>üß† Macro —Å—ç—Ç–≥—ç–≥–¥—ç–ª —Ç–æ—Ö–∏—Ä—á –±—É–π —ç—Å—ç—Ö</li>
          </ul>
        </article>
      </div>
      <section id="dashMetrics" class="metric-strip">
        <div class="feature-card">
          <span class="muted">Active Trades</span>
          <h3>5</h3>
        </div>
        <div class="feature-card">
          <span class="muted">Total Profit</span>
          <h3>$4,530</h3>
        </div>
        <div class="feature-card">
          <span class="muted">Win Rate</span>
          <h3 id="winRateValue">‚Äî</h3>
        </div>
        <div class="feature-card">
          <span class="muted">Balance</span>
          <h3>$12,750</h3>
        </div>
      </section>
    </div>
  </section>

  <footer class="site-footer">
    <div>¬© 2025 JKM Trading AI ‚Äì All rights reserved.</div>
    <nav>
      <a href="#">Privacy Policy</a>
      <a href="#">Terms</a>
      <a href="#">Risk disclosure</a>
    </nav>
  </footer>

  <script>
    const TOKEN_STORAGE_KEY = 'jkm_ai_session_v1';
    const SESSION_EXPIRED = 'SESSION_EXPIRED';
    const LANGUAGE_STORAGE_KEY = 'jkm_ai_lang_v1';
    const TRADINGVIEW_SRC = 'https://s3.tradingview.com/tv.js';
    let authToken = localStorage.getItem(TOKEN_STORAGE_KEY) || null;
    let currentUser = null;
    let tvWidget = null;
    let chartReady = false;
    let currentResolution = '15';
    let bannerTimer = null;
    let dashboardBootstrapped = false;
    let chartLoadSeq = 0;
    let contactTelegramUrl = null;
    let contactEmailAddress = null;
    let currentLang = (localStorage.getItem(LANGUAGE_STORAGE_KEY) || 'mn').toLowerCase();

    const I18N = {
      mn: {
        navHome: '–ù“Ø“Ø—Ä',
        navFeatures: '–û–Ω—Ü–ª–æ–≥',
        navHow: '–Ø–∞–∂ –∞–∂–∏–ª–ª–∞–¥–∞–≥ –≤—ç?',
        navPricing: '“Æ–Ω—ç —Ç”©–ª–±”©—Ä',
        navContact: '–•–æ–ª–±–æ–æ –±–∞—Ä–∏—Ö',
        navDashboard: '–°–∞–º–±–∞—Ä',
        navApproach: '–ê—Ä–≥–∞ –±–∞—Ä–∏–ª',
        navStrategy: '–°—Ç—Ä–∞—Ç–µ–≥–∏',
        navSettings: '–¢–æ—Ö–∏—Ä–≥–æ–æ',
        headerLogin: '–ù—ç–≤—Ç—Ä—ç—Ö',
        headerRegister: '–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö',
        headerLogout: '–ì–∞—Ä–∞—Ö',
        heroLabel: 'TRADING AUTOMATION ‚Ä¢ 24/7 SCAN',
        heroTitle: '–¢–∞–Ω—ã –∞—Ä–∏–ª–∂–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª—ã–≥ 24/7 —Å–∫–∞–Ω —Ö–∏–π–¥—ç–≥ AI —Ç—É—Å–ª–∞—Ö.',
        heroSubtitle: 'An AI trading assistant that scans the markets with your own strategy.',
        heroDesc: 'JKM AI –Ω—å trader —Ö“Ø–Ω–∏–π ”©–¥”©—Ä —Ç—É—Ç–º—ã–Ω –∞–∂–ª—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∂—É—É–ª–∞—Ö–∞–¥ –∑–æ—Ä–∏—É–ª–∞–≥–¥—Å–∞–Ω. STR –ø—Ä–æ—Ñ–∞–π–ª–¥–∞–∞ –Ω—ç–≥ —É–¥–∞–∞ –¥“Ø—Ä–º—ç—ç –æ—Ä—É—É–ª–∞–∞–¥, IG Markets API-–≥–∞–∞—Ä —Ç–∞—Å—Ä–∞–ª—Ç–≥“Ø–π —Ö—è–Ω–∞–ª—Ç —Ç–∞–≤—å–∂, —Ç–æ—Ö–∏—Ä—Å–æ–Ω setup –∏–ª—Ä—ç—Ö –º”©—á–∏–¥ Telegram –¥—ç—ç—Ä –º–æ–Ω–≥–æ–ª–æ–æ—Ä —Ç–∞–π–ª–±–∞—Ä—Ç–∞–π —Å–∏–≥–Ω–∞–ª –∏—Ä–Ω—ç.',
        heroBullet1: '‚Ä¢ 24/7 –∞–≤—Ç–æ–º–∞—Ç —Å–∫–∞–Ω ‚Äì –∑–∞—Ö –∑—ç—ç–ª —É–Ω—Ç–∞—Ö–≥“Ø–π, —Ö–∞—Ä–∏–Ω —Ç–∞ –∞–º–∞—Ä—á –±–æ–ª–Ω–æ',
        heroBullet2: '‚Ä¢ –¢–∞–Ω—ã ”©”©—Ä–∏–π–Ω –∞—Ä–≥–∞ –±–∞—Ä–∏–ª ‚Äì random —Å–∏–≥–Ω–∞–ª –±–∏—à, —Ç–∞–Ω—ã –¥“Ø—Ä–º—ç—ç—Ä',
        heroBullet3: '‚Ä¢ –≠–º–æ—Ü–∏–≥“Ø–π, —Å–∏—Å—Ç–µ–º—Ç—ç–π —à–∏–π–¥–≤—ç—Ä –≥–∞—Ä–≥–∞–ª—Ç',
        heroCtaTelegram: 'Telegram bot-–æ–æ—Ä —Ç—É—Ä—à–∏–∂ “Ø–∑—ç—Ö',
        heroCtaRegister: '“Æ–Ω—ç–≥“Ø–π –±“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö',
        featuresTitle: '–¢—Ä–µ–π–¥–µ—Ä —Ö“Ø–Ω–¥ JKM AI —è–º–∞—Ä —Ö—ç—Ä—ç–≥—Ç—ç–π –≤—ç?',
        featuresSubtitle: 'Why traders use JKM AI',
        howTitle: '–Ø–∞–∂ –∞–∂–∏–ª–ª–∞–¥–∞–≥ –≤—ç?',
        howSubtitle: '4 –∞–ª—Ö–∞–º—Ç –∞–≤—Ç–æ–º–∞—Ç–∂—É—É–ª–∞–ª—Ç',
        loginTab: '–ù—ç–≤—Ç—Ä—ç—Ö / Login',
        registerTab: '–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö / Register',
        loginEmailLabel: '–ò–º—ç–π–ª / Email',
        loginPasswordLabel: '–ù—É—É—Ü “Ø–≥ / Password',
        loginRemember: '–°–∏—Å—Ç–µ–º–¥ –Ω—ç–≤—Ç—ç—Ä—Å—ç–Ω —Ö—ç–≤—ç—ç—Ä –±–∞–π—è',
        loginForgot: '–ù—É—É—Ü “Ø–≥ –º–∞—Ä—Ç—Å–∞–Ω?',
        loginSubmit: '–ù—ç–≤—Ç—Ä—ç—Ö / Sign in',
        registerResendVerify: 'Verify –∏–º—ç–π–ª –¥–∞—Ö–∏–Ω —è–≤—É—É–ª–∞—Ö',
        verifyCodeLabel: 'Verify –∫–æ–¥ (6 –æ—Ä–æ–Ω—Ç–æ–π)',
        verifyCodeSubmit: '–ö–æ–¥–æ–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö',
        registerNameLabel: '–ù—ç—Ä / Full name',
        registerEmailLabel: '–ò–º—ç–π–ª / Email',
        registerPasswordLabel: '–ù—É—É—Ü “Ø–≥ / Password',
        registerConfirmLabel: '–ù—É—É—Ü “Ø–≥ –¥–∞–≤—Ç–∞—Ö / Confirm password',
        registerTerms: '“Æ–π–ª—á–∏–ª–≥—ç—ç–Ω–∏–π –Ω”©—Ö—Ü”©–ª –∑”©–≤—à”©”©—Ä—á –±–∞–π–Ω–∞',
        registerSubmit: '–ë“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö / Create account',
        contactTitle: 'Telegram –¥—ç—ç—Ä—ç—ç—Å —à—É—É–¥ —Ç—É—Ä—à–∏–∂ “Ø–∑—ç—Ö',
        contactDesc: 'JKM Trading AI bot-—ã–≥ Telegram –¥—ç—ç—Ä—ç—ç—Å —à—É—É–¥ —ç—Ö–ª“Ø“Ø–ª—ç—ç–¥ demo account –¥—ç—ç—Ä —Å–∏–≥–Ω–∞–ª —Ç—É—Ä—à–∞–∞—Ä–∞–π. –ê—Å—É—É–ª—Ç –±–∞–π–≤–∞–ª —á–∞—Ç –±–∏—á–∏—Ö—ç–¥ —Ö–∞–Ω–≥–∞–ª—Ç—Ç–∞–π.',
        contactTelegramLabel: 'Telegram:',
        contactEmailLabel: 'Email:',
        contactButton: 'Start Telegram Bot',
        contactHint: '–ù—ç—ç—Ö—ç–¥ Telegram app –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞–∂–∏–ª–ª–∞–Ω–∞.'
      },
      en: {
        navHome: 'Home',
        navFeatures: 'Features',
        navHow: 'How it works',
        navPricing: 'Pricing',
        navContact: 'Contact',
        navDashboard: 'Dashboard',
        navApproach: 'Approach',
        navStrategy: 'Strategy',
        navSettings: 'Settings',
        headerLogin: 'Sign in',
        headerRegister: 'Create account',
        headerLogout: 'Log out',
        heroLabel: 'TRADING AUTOMATION ‚Ä¢ 24/7 SCAN',
        heroTitle: 'An AI assistant that scans your trading strategy 24/7.',
        heroSubtitle: 'An AI trading assistant that scans the markets with your own strategy.',
        heroDesc: 'JKM AI helps automate a trader‚Äôs daily workflow. Define your rules once, then the system monitors markets continuously and notifies you when a setup appears.',
        heroBullet1: '‚Ä¢ 24/7 scanning ‚Äî markets don‚Äôt sleep, you can',
        heroBullet2: '‚Ä¢ Your own approach ‚Äî not random signals',
        heroBullet3: '‚Ä¢ Systematic decision-making, less emotion',
        heroCtaTelegram: 'Try via Telegram bot',
        heroCtaRegister: 'Free sign up',
        featuresTitle: 'Why JKM AI is useful for traders',
        featuresSubtitle: 'Why traders use JKM AI',
        howTitle: 'How it works',
        howSubtitle: 'Automation in 4 steps',
        loginTab: 'Sign in',
        registerTab: 'Register',
        loginEmailLabel: 'Email',
        loginPasswordLabel: 'Password',
        loginRemember: 'Keep me signed in',
        loginForgot: 'Forgot password?',
        loginSubmit: 'Sign in',
        registerResendVerify: 'Resend verification email',
        verifyCodeLabel: 'Verification code (6 digits)',
        verifyCodeSubmit: 'Verify code',
        registerNameLabel: 'Full name',
        registerEmailLabel: 'Email',
        registerPasswordLabel: 'Password',
        registerConfirmLabel: 'Confirm password',
        registerTerms: 'I agree to the Terms of Service',
        registerSubmit: 'Create account',
        contactTitle: 'Try it on Telegram',
        contactDesc: 'Open the JKM Trading AI bot on Telegram and try it on a demo account. Message us anytime if you have questions.',
        contactTelegramLabel: 'Telegram:',
        contactEmailLabel: 'Email:',
        contactButton: 'Open Telegram bot',
        contactHint: 'Telegram will open in a new tab.'
      }
    };

    document.addEventListener('DOMContentLoaded', initApp);

    function initApp() {
      updateHeaderAuthState();
      updateAdminUI();
      bindScrollButtons();
      bindLanguageToggle();
      bindContactButton();
      bindAuthHelpers();
      loadContactInfo();
      applyLanguage(currentLang);
      if (authToken) {
        resumeSession();
      }
    }

    function bindAuthHelpers() {
      const forgot = document.getElementById('loginForgot');
      if (forgot) {
        forgot.addEventListener('click', (e) => {
          e.preventDefault();
          setAuthStatus('–ù—É—É—Ü “Ø–≥ —Å—ç—Ä–≥—ç—ç—Ö —Ñ—É–Ω–∫—Ü –æ–¥–æ–æ–≥–æ–æ—Ä –±–∞–π—Ö–≥“Ø–π. Support/Telegram –¥—ç—ç—Ä —Ö–æ–ª–±–æ–æ –±–∞—Ä–∏–Ω–∞ —É—É.', 'info');
        });
      }

      const resendBtn = document.getElementById('registerResendVerify');
      if (resendBtn) {
        resendBtn.addEventListener('click', async () => {
          const email = (document.getElementById('registerEmail')?.value || '').trim();
          if (!email) {
            setAuthStatus('–≠—Ö–ª—ç—ç–¥ –∏–º—ç–π–ª—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
            return;
          }
          await resendVerification(email);
        });
      }

      const verifyBtn = document.getElementById('verifyCodeSubmit');
      if (verifyBtn) {
        verifyBtn.addEventListener('click', async () => {
          const email = (document.getElementById('registerEmail')?.value || '').trim();
          const code = (document.getElementById('verifyCode')?.value || '').trim();
          if (!email) {
            setAuthStatus('–≠—Ö–ª—ç—ç–¥ –∏–º—ç–π–ª—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
            return;
          }
          if (!code) {
            setAuthStatus('Verify –∫–æ–¥–æ–æ –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
            return;
          }
          await verifyWithCode(email, code);
        });
      }
    }

    async function resendVerification(email) {
      setAuthStatus('Verify –∏–º—ç–π–ª –¥–∞—Ö–∏–Ω —è–≤—É—É–ª–∂ –±–∞–π–Ω–∞...');
      try {
        const res = await fetch('/api/auth/resend-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: (email || '').trim(), password: 'ignored' }),
        });
        const data = await res.json().catch(() => ({}));
        const msg = (data && (data.detail || data.message || data.error)) || 'Verify –∏–º—ç–π–ª –¥–∞—Ö–∏–Ω —è–≤—É—É–ª–ª–∞–∞. Inbox/Spam —à–∞–ª–≥–∞–Ω–∞ —É—É.';
        if (!res.ok) throw new Error(msg);
        const suffix = (data && data.dev_code) ? ` (DEV code: ${data.dev_code})` : '';
        setAuthStatus(`${msg}${suffix}`, 'success');
      } catch (e) {
        setAuthStatus(`‚ö†Ô∏è ${e.message}`, 'error');
      }
    }

    async function verifyWithCode(email, code) {
      setAuthStatus('–ö–æ–¥–æ–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∂ –±–∞–π–Ω–∞...');
      try {
        const res = await fetch('/api/auth/verify-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: (email || '').trim(), code: (code || '').trim() }),
        });
        if (!res.ok) {
          const msg = await extractErrorMessage(res, '–ö–æ–¥ –±—É—Ä—É—É —ç—Å–≤—ç–ª —Ö—É–≥–∞—Ü–∞–∞ –¥—É—É—Å—Å–∞–Ω –±–∞–π–Ω–∞.');
          throw new Error(msg);
        }
        const data = await res.json();
        handleAuthSuccess(data.user, data.token, { statusMessage: '–ò–º—ç–π–ª –±–∞—Ç–∞–ª–≥–∞–∞–∂–ª–∞–∞. –°–∞–º–±–∞—Ä —Ä—É—É —à–∏–ª–∂–∏–∂ –±–∞–π–Ω–∞...' });
      } catch (e) {
        setAuthStatus(`‚ö†Ô∏è ${e.message}`, 'error');
      }
    }

    function bindScrollButtons() {
      document.querySelectorAll('[data-scroll]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.dataset.scroll);
          if (target) target.scrollIntoView({ behavior: 'smooth' });
        });
      });
    }

    function bindLanguageToggle() {
      document.querySelectorAll('.language-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          const lang = (btn.dataset.lang || 'mn').toLowerCase();
          setLanguage(lang);
        });
      });
    }

    function setLanguage(lang) {
      currentLang = (lang || 'mn').toLowerCase();
      localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLang);
      document.querySelectorAll('.language-toggle button').forEach(b => {
        b.classList.toggle('active', (b.dataset.lang || '').toLowerCase() === currentLang);
      });
      applyLanguage(currentLang);
    }

    function applyLanguage(lang) {
      const table = I18N[(lang || 'mn').toLowerCase()] || I18N.mn;
      document.documentElement.lang = (lang || 'mn').toLowerCase();
      Object.keys(table).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = table[id];
      });
    }

    function bindContactButton() {
      const btn = document.getElementById('contactButton');
      if (!btn) return;
      btn.type = 'button';
      btn.addEventListener('click', () => {
        if (contactTelegramUrl) {
          window.open(contactTelegramUrl, '_blank');
        } else {
          showBanner('Telegram —Ö–æ–ª–±–æ–æ—Å —Ç“Ø—Ä –æ–ª–¥—Å–æ–Ω–≥“Ø–π.', 'error');
        }
      });
    }

    async function loadContactInfo() {
      try {
        const res = await fetch('/api/contact');
        if (!res.ok) return;
        const data = await res.json();
        contactTelegramUrl = data.telegram_url || contactTelegramUrl;
        contactEmailAddress = data.support_email || contactEmailAddress;
        const telegramEl = document.getElementById('contactTelegram');
        if (telegramEl && contactTelegramUrl) {
          telegramEl.href = contactTelegramUrl;
          telegramEl.textContent = formatTelegramHandle(contactTelegramUrl);
        }
        const emailEl = document.getElementById('contactEmail');
        if (emailEl && contactEmailAddress) {
          emailEl.href = `mailto:${contactEmailAddress}`;
          emailEl.textContent = contactEmailAddress;
        }
      } catch (err) {
        console.warn('Contact info load error:', err);
      }
    }

    function formatTelegramHandle(url) {
      if (!url) return '';
      const clean = url.replace(/^https?:\/\/t\.me\//i, '');
      if (!clean) return url;
      return clean.startsWith('@') ? clean : `@${clean}`;
    }

    function setActiveAuthTab(mode) {
      const loginTab = document.getElementById('loginTab');
      const registerTab = document.getElementById('registerTab');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      if (!loginTab || !registerTab || !loginForm || !registerForm) return;
      if (mode === 'login') {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
      } else {
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
      }
    }

    async function resumeSession() {
      try {
        const res = await apiFetch('/api/auth/me');
        if (!res.ok) throw new Error('Session invalid');
        const data = await res.json();
        handleAuthSuccess(data.user, authToken, { silent: true });
      } catch (err) {
        if (!isSessionExpiredError(err)) {
          console.warn('Session resume failed:', err);
        }
        clearSession(true);
      }
    }

    async function handleAuthSubmit(event, mode) {
      event.preventDefault();
      if (mode === 'register') {
        const payload = {
          name: document.getElementById('registerName')?.value.trim() || 'Trader',
          email: (document.getElementById('registerEmail')?.value || '').trim(),
          password: document.getElementById('registerPassword')?.value || '',
        };
        const confirmPassword = document.getElementById('registerPasswordConfirm')?.value || '';
        if (!payload.email) {
          setAuthStatus('–ò–º—ç–π–ª—ç—ç –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
          return;
        }
        if (payload.password.length < 8) {
          setAuthStatus('–ù—É—É—Ü “Ø–≥ —Ö–∞–º–≥–∏–π–Ω –±–∞–≥–∞–¥–∞–∞ 8 —Ç—ç–º–¥—ç–≥—Ç –±–∞–π–Ω–∞.', 'error');
          return;
        }
        if (payload.password !== confirmPassword) {
          setAuthStatus('–ù—É—É—Ü “Ø–≥ —Ö–æ—ë—Ä —Ö–æ–æ—Ä–æ–Ω–¥–æ–æ —Ç–∞–∞—Ä–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.', 'error');
          return;
        }
        setAuthStatus('–ë“Ø—Ä—Ç–≥“Ø“Ø–ª–∂ –±–∞–π–Ω–∞...');
        try {
          const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const msg = await extractErrorMessage(res, '–ë“Ø—Ä—Ç–≥—ç–ª –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–ª–æ–æ.');
            throw new Error(msg);
          }
          const data = await res.json().catch(() => ({}));
          setActiveAuthTab('register');
          const verifySection = document.getElementById('registerVerifySection');
          if (verifySection) verifySection.style.display = 'block';
          const verifyCode = document.getElementById('verifyCode');
          if (verifyCode) verifyCode.value = '';
          if (verifyCode) verifyCode.focus();
          const suffix = (data && data.dev_code) ? ` (DEV code: ${data.dev_code})` : '';
          setAuthStatus(`–ò–º—ç–π–ª —Ä“Ø“Ø 6 –æ—Ä–æ–Ω—Ç–æ–π verify –∫–æ–¥ —è–≤—É—É–ª–ª–∞–∞. –ö–æ–¥–æ–æ –æ—Ä—É—É–ª–∞–∞–¥ "–ö–æ–¥–æ–æ—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö" –¥—ç—ç—Ä –¥–∞—Ä–Ω–∞ —É—É.${suffix}`, 'success');
        } catch (err) {
          setAuthStatus(`‚ö†Ô∏è ${err.message}`, 'error');
        }
        return;
      }

      const email = (document.getElementById('loginEmail')?.value || '').trim();
      const password = document.getElementById('loginPassword')?.value || '';
      if (!email || !password) {
        setAuthStatus('–ò–º—ç–π–ª –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥—ç—ç –±”©–≥–ª”©–Ω”© “Ø“Ø.', 'error');
        return;
      }
      setAuthStatus('–ù—ç–≤—Ç—ç—Ä—á –±–∞–π–Ω–∞...');
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        if (!res.ok) {
          const msg = await extractErrorMessage(res, '–ù—ç–≤—Ç—Ä—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.');
          throw new Error(msg);
        }
        const data = await res.json();
        handleAuthSuccess(data.user, data.token, { statusMessage: '–ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–ª—ç—ç. –°–∞–º–±–∞—Ä —Ä—É—É —à–∏–ª–∂–∏–∂ –±–∞–π–Ω–∞...' });
      } catch (err) {
        const raw = String(err.message || '');
        setAuthStatus(`‚ö†Ô∏è ${raw}`, 'error');
      }
    }

    async function extractErrorMessage(response, fallback) {
      try {
        const data = await response.json();
        if (!data) return fallback;
        if (typeof data === 'string') return data;
        if (data.detail) return data.detail;
        if (data.error) return data.error;
        if (data.message) return data.message;
      } catch (err) {
        return fallback;
      }
      return fallback;
    }

    function handleAuthSuccess(user, token, options = {}) {
      const { silent = false, statusMessage } = options;
      currentUser = user;
      authToken = token;
      localStorage.setItem(TOKEN_STORAGE_KEY, token);
      updateHeaderAuthState();
      updateAdminUI();
      if (user && user.email_verified === false) {
        setAuthStatus('–ù—ç–≤—Ç—ç—Ä–ª—ç—ç. –ê–Ω—Ö–∞–∞—Ä: –∏–º—ç–π–ª –±–∞—Ç–∞–ª–≥–∞–∞–∂–∞–∞–≥“Ø–π –±–∞–π–Ω–∞ (—Ö“Ø—Å–≤—ç–ª verify code –æ—Ä—É—É–ª–∞–∞–¥ –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∂ –±–æ–ª–Ω–æ).', 'info');
      } else {
        setAuthStatus(statusMessage || '', statusMessage ? 'success' : 'info');
      }
      showDashboard({ silent });
    }

    function showDashboard({ silent = false } = {}) {
      if (!currentUser) return;
      document.body.classList.add('auth-mode');
      if (!dashboardBootstrapped) {
        bootstrapDashboard();
      } else {
        refreshStr();
        loadProfile();
        refreshMetrics();
        updateAdminUI();
      }
      if (!silent) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function bootstrapDashboard() {
      updateSetupStats(null, null);
      initPairs();
      loadProfile();
      refreshMetrics();
      updateAdminUI();
      dashboardBootstrapped = true;
    }

    async function refreshMetrics() {
      if (!assertAuthenticated(false)) return;
      const winEl = document.getElementById('winRateValue');
      if (winEl) winEl.textContent = '‚Äî';
      try {
        const res = await apiFetch('/api/metrics');
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        const data = await res.json();
        if (data && typeof data.winrate === 'number' && winEl) {
          winEl.textContent = `${data.winrate.toFixed(1)}%`;
        }
      } catch (err) {
        if (winEl) winEl.textContent = '‚Äî';
      }
    }

    async function logoutUser() {
      if (authToken) {
        try {
          await apiFetch('/api/auth/logout', { method: 'POST' });
        } catch (err) {
          if (!isSessionExpiredError(err)) {
            console.warn('Logout error:', err);
          }
        }
      }
      clearSession();
    }

    function clearSession(silent = false) {
      authToken = null;
      currentUser = null;
      localStorage.removeItem(TOKEN_STORAGE_KEY);
      document.body.classList.remove('auth-mode');
      updateHeaderAuthState();
      updateAdminUI();
      const summary = document.getElementById('profileSummary');
      if (summary) summary.textContent = '';
      const nameInput = document.getElementById('profileName');
      if (nameInput) nameInput.value = '';
      const noteInput = document.getElementById('profileNote');
      if (noteInput) noteInput.value = '';
      updateSetupStats(null, null);
      if (!silent) {
        setAuthStatus('');
      }
      dashboardBootstrapped = false;
    }

    function updateHeaderAuthState() {
      const authButtons = document.querySelector('.auth-buttons');
      const accountPill = document.querySelector('.account-pill');
      if (currentUser) {
        if (authButtons) authButtons.style.display = 'none';
        if (accountPill) accountPill.style.display = 'inline-flex';
        const nameEl = document.getElementById('accountName');
        const roleEl = document.getElementById('accountRole');
        if (nameEl) nameEl.textContent = currentUser.name || 'Trader';
        if (roleEl) roleEl.textContent = currentUser.is_admin ? 'Admin' : 'Member';
      } else {
        if (authButtons) authButtons.style.display = 'flex';
        if (accountPill) accountPill.style.display = 'none';
      }
    }

    function updateAdminUI() {
      const isAdmin = Boolean(currentUser && currentUser.is_admin);
      const adminStatus = document.getElementById('adminStatus');
      const adminHint = document.getElementById('adminHint');
      const profilesList = document.getElementById('profilesList');
      const profileForm = document.getElementById('profileForm');
      if (profileForm) {
        profileForm.style.display = currentUser ? 'block' : 'none';
      }
      if (!adminStatus || !adminHint || !profilesList) return;
      if (isAdmin) {
        adminStatus.style.display = 'inline-flex';
        adminHint.textContent = '–ê–¥–º–∏–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á –±—É—Å–∞–¥ –ø—Ä–æ—Ñ–∞–π–ª—ã–≥ —É–¥–∏—Ä–¥–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π.';
        profilesList.style.display = 'flex';
        loadProfiles();
      } else {
        adminStatus.style.display = 'none';
        adminHint.textContent = currentUser ? '”®”©—Ä–∏–π–Ω STR –ø—Ä–æ—Ñ–∞–π–ª–∞–∞ –¥–æ–æ—Ä–æ–æ—Å —à–∏–Ω—ç—á–∏–ª–Ω—ç “Ø“Ø.' : '–ù—ç–≤—Ç—ç—Ä—Å–Ω–∏–π –¥–∞—Ä–∞–∞ –ø—Ä–æ—Ñ–∞–π–ª–∞–∞ —É–¥–∏—Ä–¥–∞–Ω–∞.';
        profilesList.style.display = 'none';
        profilesList.innerHTML = '';
      }
    }

    function assertAuthenticated(showWarning = true) {
      if (!authToken) {
        if (showWarning) showBanner('–≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ —Ö–∏–π—Ö–∏–π–Ω —Ç—É–ª–¥ –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø.');
        return false;
      }
      return true;
    }

    async function apiFetch(url, options = {}) {
      const opts = { ...options };
      const headers = new Headers(options.headers || {});
      if (authToken) {
        headers.set('Authorization', `Bearer ${authToken}`);
      }
      opts.headers = headers;
      const response = await fetch(url, opts);
      if (response.status === 401) {
        clearSession(true);
        throw new Error(SESSION_EXPIRED);
      }
      return response;
    }

    function isSessionExpiredError(err) {
      return err && err.message === SESSION_EXPIRED;
    }

    function setAuthStatus(message, type = 'info') {
      const el = document.getElementById('authStatus');
      if (!el) return;
      el.style.color = type === 'error' ? '#d14343' : varColor('--accent');
      el.textContent = message || '';
    }

    function formatPairLabel(symbol) {
      if (!symbol) return '‚Äî';
      if (symbol.includes('/')) return symbol;
      if (symbol.length === 6) {
        return `${symbol.slice(0, 3)}/${symbol.slice(3)}`;
      }
      return symbol;
    }

    function varColor(token) {
      const value = getComputedStyle(document.documentElement).getPropertyValue(token);
      return value && value.trim() ? value.trim() : '#3b7bff';
    }

    function showBanner(message = '', type = 'error') {
      const el = document.getElementById('validationMsg');
      if (!el) return;
      el.style.color = type === 'success' ? varColor('--accent') : '#d14343';
      el.textContent = message || '';
      if (bannerTimer) clearTimeout(bannerTimer);
      if (message) {
        bannerTimer = setTimeout(() => {
          el.textContent = '';
        }, 3500);
      }
    }

    function formatLevel(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num.toFixed(5) : (value ?? '‚Äî');
    }

    function formatProfileSummary(profile) {
      if (!profile || typeof profile !== 'object') return '';
      const pieces = [];
      if (profile.trend_tf) pieces.push(`–¢—Ä–µ–Ω–¥ TF: ${profile.trend_tf}`);
      if (profile.entry_tf) pieces.push(`Entry TF: ${profile.entry_tf}`);
      if (profile.min_rr) pieces.push(`RR ‚â• ${profile.min_rr}`);
      if (profile.tz_offset_hours !== undefined && profile.tz_offset_hours !== null) {
        const tz = Number(profile.tz_offset_hours);
        if (Number.isFinite(tz)) pieces.push(`Timezone: UTC${tz >= 0 ? '+' : ''}${tz}`);
      }
      if (profile.note) pieces.push(profile.note);
      return `${profile.name || '–ù—ç—Ä–≥“Ø–π –ø—Ä–æ—Ñ–∞–π–ª'}${pieces.length ? ' ‚Ä¢ ' + pieces.join(' ‚Ä¢ ') : ''}`;
    }

    function markLastUpdate() {
      const ts = new Date().toLocaleTimeString('en-GB', { hour12: false });
      const chartLabel = document.getElementById('lastUpdateLabel');
      const setupLabel = document.getElementById('setupUpdatedAt');
      if (chartLabel) chartLabel.textContent = ts;
      if (setupLabel) setupLabel.textContent = ts;
    }

    function updateSetupStats(setup, pair) {
      const panel = document.getElementById('setupStats');
      if (!panel) return;
      if (!setup) {
        panel.innerHTML = `
          <span>–°—Ç–∞—Ç—É—Å</span><span>–°–µ—Ç–∞–ø –∏–ª—Ä—ç—ç–≥“Ø–π</span>
          <span>–•–æ—Å</span><span>‚Äî</span>
          <span>Entry / SL / TP</span><span>‚Äî</span>
          <span>RR</span><span>‚Äî</span>
        `;
        panel.dataset.hasSetup = 'false';
        panel.dataset.entry = '';
        panel.dataset.sl = '';
        panel.dataset.tp = '';
        panel.dataset.direction = '';
        panel.dataset.pair = '';
        return;
      }
      const rrValue = Number(setup.rr);
      panel.innerHTML = `
        <span>–°—Ç–∞—Ç—É—Å</span><span>‚úÖ –°–µ—Ç–∞–ø –±—ç–ª—ç–Ω</span>
        <span>–•–æ—Å</span><span>${formatPairLabel(pair || setup.pair)}</span>
        <span>–ß–∏–≥–ª—ç–ª</span><span>${setup.direction || '‚Äî'}</span>
        <span>Entry / SL / TP</span><span>${formatLevel(setup.entry)} / ${formatLevel(setup.sl)} / ${formatLevel(setup.tp)}</span>
        <span>RR</span><span>${Number.isFinite(rrValue) ? rrValue.toFixed(2) : '‚Äî'}</span>
      `;
      panel.dataset.hasSetup = 'true';
      panel.dataset.entry = setup.entry ?? '';
      panel.dataset.sl = setup.sl ?? '';
      panel.dataset.tp = setup.tp ?? '';
      panel.dataset.direction = setup.direction ?? '';
      panel.dataset.pair = pair || setup.pair || '';
    }

    async function copySetupLevels() {
      const panel = document.getElementById('setupStats');
      if (!panel || panel.dataset.hasSetup !== 'true') {
        showBanner('‚ö†Ô∏è –û–¥–æ–æ–≥–æ–æ—Ä –∏–¥—ç–≤—Ö—Ç—ç–π —Å–µ—Ç–∞–ø –∞–ª–≥–∞.', 'error');
        return;
      }
      const text = `Pair: ${panel.dataset.pair}\nDirection: ${panel.dataset.direction}\nEntry: ${panel.dataset.entry}\nSL: ${panel.dataset.sl}\nTP: ${panel.dataset.tp}`;
      try {
        await navigator.clipboard.writeText(text);
        showBanner('‚úÖ Level-—É—É–¥ clipboard —Ä—É—É —Ö—É—É–ª–ª–∞–∞.', 'success');
      } catch (err) {
        showBanner(`‚ö†Ô∏è Clipboard –∞–ª–¥–∞–∞: ${err.message}`, 'error');
      }
    }

    async function initPairs() {
      const sel = document.getElementById('pairSelect');
      if (!sel) return;
      const applyHandlers = () => {
        sel.onchange = () => {
          loadChart(sel.value);
          refreshStr();
        };
      };
      try {
        const res = await fetch('/api/pairs');
        if (!res.ok) throw new Error('API –∞–ª–¥–∞–∞');
        const pairs = await res.json();
        sel.innerHTML = '';
        pairs.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.symbol;
          opt.textContent = p.symbol;
          sel.appendChild(opt);
        });
        applyHandlers();
        if (pairs.length > 0) {
          loadChart(pairs[0].symbol);
          refreshStr();
          return;
        }
      } catch (err) {
        showBanner(`‚ö†Ô∏è –•–æ—Å–ª–æ–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ —Ç–∞—Ç–∞–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π: ${err.message}`);
      }
      applyHandlers();
      if (sel.value) {
        loadChart(sel.value);
        refreshStr();
      }
    }

    function setChartFallback(messageHtml) {
      const host = document.getElementById('tv_chart');
      if (!host) return;
      host.innerHTML = `<div class="chart-fallback">${messageHtml || ''}</div>`;
    }

    function ensureTradingViewLoaded(timeoutMs = 8000) {
      return new Promise((resolve, reject) => {
        if (window.TradingView && typeof window.TradingView.widget === 'function') {
          resolve(true);
          return;
        }

        const existing = document.querySelector(`script[src="${TRADINGVIEW_SRC}"]`);
        if (!existing) {
          const script = document.createElement('script');
          script.src = TRADINGVIEW_SRC;
          script.async = true;
          document.head.appendChild(script);
        }

        const start = Date.now();
        const timer = setInterval(() => {
          if (window.TradingView && typeof window.TradingView.widget === 'function') {
            clearInterval(timer);
            resolve(true);
            return;
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(timer);
            reject(new Error('TRADINGVIEW_LOAD_TIMEOUT'));
          }
        }, 250);
      });
    }

    function mapToTradingViewSymbol(rawSymbol) {
      const sym = (rawSymbol || '').trim();
      if (!sym) return '';
      if (sym.includes(':')) return sym;

      const normalized = sym.replace('/', '').toUpperCase();
      const map = {
        // FX + metals (commonly available)
        EURUSD: 'OANDA:EURUSD',
        GBPUSD: 'OANDA:GBPUSD',
        USDJPY: 'OANDA:USDJPY',
        GBPJPY: 'OANDA:GBPJPY',
        USDCHF: 'OANDA:USDCHF',
        XAUUSD: 'OANDA:XAUUSD',

        // Crypto
        BTCUSD: 'COINBASE:BTCUSD',
        BITCOIN: 'COINBASE:BTCUSD',
      };

      return map[normalized] || normalized;
    }

    function loadChart(symbol) {
      if (!symbol) return;
      const tvSymbol = mapToTradingViewSymbol(symbol);
      const seq = ++chartLoadSeq;
      chartReady = false;
      setChartFallback('‚è≥ Chart –∞—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...');
      try {
        if (tvWidget && typeof tvWidget.remove === 'function') {
          tvWidget.remove();
        }
      } catch (_) {
        // ignore
      }
      tvWidget = null;

      ensureTradingViewLoaded()
        .then(() => {
          if (seq !== chartLoadSeq) return;
          try {
            tvWidget = new TradingView.widget({
              container_id: 'tv_chart',
              symbol: tvSymbol,
              interval: currentResolution,
              timezone: 'Etc/UTC',
              theme: 'light',
              style: '1',
              locale: 'en',
              autosize: true,
            });
            // Free Widget doesn't support onChartReady
            // tvWidget.onChartReady(() => {
            //   if (seq !== chartLoadSeq) return;
            //   chartReady = true;
            // });
            chartReady = true;
          } catch (err) {
            console.warn('TradingView widget init failed:', err);
            const errText = (err && (err.message || err.name)) ? (err.message || err.name) : String(err);
            setChartFallback(
              `<strong>TradingView widget –∞—Å–∞—Ö–≥“Ø–π –±–∞–π–Ω–∞.</strong><br>` +
              `Symbol: <strong>${escapeHtml(symbol)}</strong> ‚Üí <strong>${escapeHtml(tvSymbol)}</strong><br>` +
              `Error: <span>${escapeHtml(errText)}</span><br>` +
              `–®–∞–ª—Ç–≥–∞–∞–Ω: tv.js/TradingView embed –±–ª–æ–∫–ª–æ–≥–¥—Å–æ–Ω (Adblock/Firewall) —ç—Å–≤—ç–ª symbol provider –¥—ç—ç—Ä –±–∞–π—Ö–≥“Ø–π –±–∞–π–∂ –±–æ–ª–Ω–æ.`
            );
          }
        })
        .catch(err => {
          console.warn('TradingView script load failed:', err);
          if (seq !== chartLoadSeq) return;
          setChartFallback(
            `<strong>TradingView script –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π.</strong><br>` +
            `–ò–Ω—Ç–µ—Ä–Ω–µ—Ç/Firewall/Adblock tv.js-–∏–π–≥ —Ö–∞–∞–∂ –±–∞–π–≥–∞–∞ –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π.`
          );
        });
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setChartResolution(interval, clickedButton) {
      if (!tvWidget) return;
      currentResolution = interval;

      // Free widget requires full reload to change property
      const sel = document.getElementById('pairSelect');
      if (sel && sel.value) {
        loadChart(sel.value);
      }
      const buttons = document.querySelectorAll('.chart-controls button');
      buttons.forEach(btn => {
        const isActive = clickedButton ? btn === clickedButton : btn.dataset.resolution === interval;
        btn.classList.toggle('active', isActive);
      });
    }

    async function refreshStr() {
      if (!assertAuthenticated()) return;
      const select = document.getElementById('pairSelect');
      if (!select) return;
      const symbol = select.value;
      if (!symbol) {
        showBanner('‚ö†Ô∏è –•–æ—Å–ª–æ–ª —Å–æ–Ω–≥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞!');
        return;
      }
      showBanner('');
      const outputEl = document.getElementById('aiOutput');
      if (!outputEl) return;
      outputEl.textContent = '‚è≥ STR —à–∏–Ω–∂–∏–ª–≥—ç—ç —Ö–∏–π–≥–¥—ç–∂ –±–∞–π–Ω–∞...';
      try {
        const res = await apiFetch(`/api/str-analyze?symbol=${encodeURIComponent(symbol)}`);
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        const data = await res.json();
        const prof = data.profile || {};
        document.getElementById('profileSummary').textContent = formatProfileSummary(prof);
        let text = '';
        if (data.setup) {
          const s = data.setup;
          text += `‚úÖ ${formatPairLabel(data.pair)} ${s.direction}\n`;
          text += `Entry: ${s.entry} | SL: ${s.sl} | TP: ${s.tp} | RR: ${s.rr}\n\n`;
          text += data.ai_explanation || '';
        } else {
          text += data.ai_explanation || '–û–¥–æ–æ–≥–æ–æ—Ä —Ç–æ—Ö–∏—Ä–æ—Ö —Å–µ—Ç–∞–ø –∏–ª—Ä—ç—ç–≥“Ø–π –±–∞–π–Ω–∞.';
          if (data.reasons && data.reasons.length) {
            text += '\n\n–®–∞–ª—Ç–≥–∞–∞–Ω—É—É–¥:\n- ' + data.reasons.join('\n- ');
          }
        }
        outputEl.textContent = text;
        updateSetupStats(data.setup || null, data.pair);
        markLastUpdate();
      } catch (err) {
        if (isSessionExpiredError(err)) {
          outputEl.textContent = '‚ö†Ô∏è –°–µ—à–Ω –¥—É—É—Å—Å–∞–Ω. –î–∞—Ö–∏–Ω –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø.';
        } else {
          outputEl.textContent = `‚ö†Ô∏è STR —à–∏–Ω–∂–∏–ª–≥—ç—ç –∞–º–∂–∏–ª—Ç–≥“Ø–π: ${err.message}`;
        }
        updateSetupStats(null, null);
      }
    }

    async function refreshTech() {
      if (!assertAuthenticated()) return;
      const symbol = document.getElementById('pairSelect')?.value;
      if (!symbol) {
        showBanner('‚ö†Ô∏è –•–æ—Å–ª–æ–ª —Å–æ–Ω–≥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞!');
        return;
      }
      const outputEl = document.getElementById('aiOutput');
      if (!outputEl) return;
      outputEl.textContent = '‚è≥ –¢–µ—Ö–Ω–∏–∫ —à–∏–Ω–∂–∏–ª–≥—ç—ç —Ç–∞—Ç–∞–∂ –±–∞–π–Ω–∞...';
      try {
        const res = await apiFetch(`/api/tech-analyze?symbol=${encodeURIComponent(symbol)}`);
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        const data = await res.json();
        outputEl.textContent = data.analysis_text || JSON.stringify(data, null, 2);
        markLastUpdate();
      } catch (err) {
        if (isSessionExpiredError(err)) {
          outputEl.textContent = '‚ö†Ô∏è –°–µ—à–Ω –¥—É—É—Å—Å–∞–Ω. –î–∞—Ö–∏–Ω –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø.';
        } else {
          outputEl.textContent = `‚ö†Ô∏è –¢–µ—Ö–Ω–∏–∫ —à–∏–Ω–∂–∏–ª–≥—ç—ç–Ω–∏–π –∞–ª–¥–∞–∞: ${err.message}`;
        }
      }
    }

    async function refreshMacro() {
      if (!assertAuthenticated()) return;
      const outputEl = document.getElementById('aiOutput');
      if (!outputEl) return;
      outputEl.textContent = '‚è≥ –ú–∞–∫—Ä–æ —Ç–æ–π–º —Ç–∞—Ç–∞–∂ –±–∞–π–Ω–∞...';
      try {
        const res = await apiFetch('/api/macro');
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        const data = await res.json();
        outputEl.textContent = data.overview_text || JSON.stringify(data, null, 2);
        markLastUpdate();
      } catch (err) {
        if (isSessionExpiredError(err)) {
          outputEl.textContent = '‚ö†Ô∏è –°–µ—à–Ω –¥—É—É—Å—Å–∞–Ω. –î–∞—Ö–∏–Ω –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø.';
        } else {
          outputEl.textContent = `‚ö†Ô∏è –ú–∞–∫—Ä–æ —Ç–æ–π–º —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞: ${err.message}`;
        }
      }
    }

    async function loadProfile() {
      if (!assertAuthenticated(false)) return;
      try {
        const res = await apiFetch('/api/profile');
        if (!res.ok) throw new Error('–ü—Ä–æ—Ñ–∞–π–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π');
        const profile = await res.json();
        document.getElementById('profileSummary').textContent = formatProfileSummary(profile);
        const nameInput = document.getElementById('profileName');
        const noteInput = document.getElementById('profileNote');
        const tzInput = document.getElementById('profileTzOffset');
        if (nameInput) nameInput.value = profile.name || '';
        if (noteInput) noteInput.value = profile.note || '';
        if (tzInput) tzInput.value = (profile.tz_offset_hours ?? 8);
      } catch (err) {
        console.warn('–ü—Ä–æ—Ñ–∞–π–ª –∞—á–∞–∞–ª–∞—Ö “Ø–µ–¥ –∞–ª–¥–∞–∞:', err);
      }
    }

    async function saveProfile() {
      if (!assertAuthenticated()) return;
      const name = document.getElementById('profileName')?.value.trim() || 'Trader';
      const note = document.getElementById('profileNote')?.value.trim() || '';
      const tzRaw = document.getElementById('profileTzOffset')?.value;
      let tzOffset = 8;
      if (tzRaw !== undefined && tzRaw !== null && String(tzRaw).trim() !== '') {
        const parsed = Number(tzRaw);
        if (Number.isFinite(parsed)) tzOffset = Math.max(-12, Math.min(14, Math.trunc(parsed)));
      }
      const body = {
        name,
        profile: {
          name,
          note,
          tz_offset_hours: tzOffset,
        },
      };
      try {
        const res = await apiFetch('/api/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        showBanner('‚úÖ –ü—Ä–æ—Ñ–∞–π–ª —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.', 'success');
        await loadProfile();
        await loadProfiles();
      } catch (err) {
        showBanner(`‚ö†Ô∏è –ü—Ä–æ—Ñ–∞–π–ª —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞: ${err.message}`);
      }
    }

    async function loadProfiles() {
      if (!assertAuthenticated(false)) return;
      if (!currentUser || !currentUser.is_admin) return;
      try {
        const res = await apiFetch('/api/profiles');
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        const profiles = await res.json();
        renderProfilesList(profiles);
      } catch (err) {
        showBanner(`‚ö†Ô∏è –ü—Ä–æ—Ñ–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞: ${err.message}`);
      }
    }

    function renderProfilesList(profiles) {
      const container = document.getElementById('profilesList');
      if (!container) return;
      if (!profiles || profiles.length === 0) {
        container.innerHTML = '<p style="font-size:12px; opacity:0.8;">–ü—Ä–æ—Ñ–∞–π–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.</p>';
        return;
      }
      container.innerHTML = profiles.map(p => {
        const safeId = String(p.user_id || '').replace(/'/g, "\\'");
        const safeEmail = String(p.email || '').replace(/'/g, "\\'");
        const safeName = String(p.name || '').replace(/'/g, "\\'");
        return `
          <div class="profile-row">
            <div>
              <strong>${p.name || '–ù—ç—Ä–≥“Ø–π'}</strong>
              <div style="font-size:11px; color:var(--muted);">${p.email || ''}</div>
              <div style="font-size:11px; color:var(--muted);">RR ‚â• ${p.min_rr || '-'} | TF: ${p.entry_tf || '-'}</div>
            </div>
            <button type="button" onclick="deleteProfile('${safeId}', '${safeEmail}', '${safeName}')">–£—Å—Ç–≥–∞—Ö</button>
          </div>
        `;
      }).join('');
    }

    async function deleteProfile(userId, email, name) {
      if (!userId || !assertAuthenticated()) return;
      if (!currentUser?.is_admin) {
        showBanner('‚ö†Ô∏è –ó”©–≤—Ö”©–Ω –∞–¥–º–∏–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á —É—Å—Ç–≥–∞—Ö —ç—Ä—Ö—Ç—ç–π.');
        return;
      }

      if (currentUser && String(currentUser.user_id) === String(userId)) {
        showBanner('‚ö†Ô∏è ”®”©—Ä–∏–π–Ω –∞–∫–∫–∞—É–Ω—Ç—ã–≥ —É—Å—Ç–≥–∞—Ö—ã–≥ —Ö–æ—Ä–∏–≥–ª–æ—Å–æ–Ω.', 'error');
        return;
      }

      const label = (email || name) ? `${name || ''}${(name && email) ? ' ‚Äî ' : ''}${email || ''}` : userId;
      const ok = window.confirm(`–≠–Ω—ç –ø—Ä–æ—Ñ–∞–π–ª—ã–≥ —É—Å—Ç–≥–∞—Ö —É—É?\n\n${label}\n\n–≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ –±—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.`);
      if (!ok) return;

      try {
        const res = await apiFetch(`/api/profile?user_id=${encodeURIComponent(userId)}`, {
          method: 'DELETE',
        });
        if (!res.ok) throw new Error('API —Ö–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç–≥“Ø–π');
        showBanner('‚úÖ –ü—Ä–æ—Ñ–∞–π–ª —É—Å—Ç–≥–∞–≥–¥–ª–∞–∞.', 'success');
        await loadProfiles();
      } catch (err) {
        showBanner(`‚ö†Ô∏è –ü—Ä–æ—Ñ–∞–π–ª —É—Å—Ç–≥–∞—Ö–∞–¥ –∞–ª–¥–∞–∞: ${err.message}`);
      }
    }
  </script>
</body>

</html>