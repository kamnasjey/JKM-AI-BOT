# market_overview.py
"""
–ó–∞—Ö –∑—ç—ç–ª–∏–π–Ω —Ç–æ–π–º.

–•–æ—ë—Ä –≥–æ—Ä–∏–º:
  1) OPENAI_API_KEY –±–∞–π–≥–∞–∞ –±–æ–ª ‚Äì OpenAI-—Ä—É—É –±–æ–≥–∏–Ω–æ prompt —è–≤—É—É–ª–∂, 
     –µ—Ä”©–Ω—Ö–∏–π —Ñ–æ—Ä–µ–∫—Å –º–∞–∫—Ä–æ —Ç–æ–π–º –∞–Ω–≥–ª–∏–∞—Ä –±–∏—à, –º–æ–Ω–≥–æ–ª–æ–æ—Ä –∞–≤–∞—Ö.
  2) –ö–ª—é—á –±–∞–π—Ö–≥“Ø–π –±–æ–ª ‚Äì demo, —Å—Ç–∞—Ç–∏–∫ —Ç–µ–∫—Å—Ç –±—É—Ü–∞–∞–Ω–∞.

–°–∞–Ω—É—É–ª–∞—Ö: OpenAI API –Ω—å ”©”©—Ä”©”© real-time –¥–∞—Ç–∞ —Ç–∞—Ç–∞—Ö–≥“Ø–π, –µ—Ä”©–Ω—Ö–∏–π –º—ç–¥–ª—ç–≥—ç—ç—Ä
–æ–π–ª–≥–æ–º–∂—Ç–æ–π —Ç–æ–π–º ”©–≥–Ω”©. –ñ–∏–Ω—Ö—ç–Ω—ç macro –∫–∞–ª–µ–Ω–¥–∞—Ä –∞—à–∏–≥–ª–∞—Ö—ã–≥ —Ö“Ø—Å–≤—ç–ª 
–¥–∞—Ä–∞–∞ –Ω—å investing.com / forexfactory scrape —Ö–∏–π—Ö–∏–π–≥ –Ω—ç–º–Ω—ç.
"""

from __future__ import annotations
import os
from datetime import datetime


def get_market_overview_text() -> str:
    today = datetime.utcnow().strftime("%Y-%m-%d")

    api_key = str(os.getenv("OPENAI_API_KEY", "") or "").strip()
    if not api_key:
        # Demo —Ç–µ–∫—Å—Ç ‚Äì —è–º–∞—Ä —á –∞–ª–¥–∞–∞ —à–∏–¥—ç—Ö–≥“Ø–π, –∑“Ø–≥—ç—ç—Ä –ª –æ–π–ª–≥–æ–º–∂—Ç–æ–π —Ç–æ–π–º.
        return (
            "üìä <b>–ó–∞—Ö –∑—ç—ç–ª–∏–π–Ω —Ç–æ–≤—á —Ç–æ–π–º (demo)</b>\n"
            f"”®–Ω”©”©–¥—Ä–∏–π–Ω –æ–≥–Ω–æ–æ: {today} (UTC)\n\n"
            "–û–¥–æ–æ–≥–∏–π–Ω —Ö—É–≤–∏–ª–±–∞—Ä –¥—ç—ç—Ä –º–∞–∫—Ä–æ —ç–¥–∏–π–Ω –∑–∞—Å–≥–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ —à—É—É–¥ –≤—ç–±—ç—ç—Å —Ç–∞—Ç–∞—Ö–≥“Ø–π,\n"
            "–µ—Ä”©–Ω—Ö–∏–π–¥”©”© –¥–∞—Ä–∞–∞—Ö –∑–∞—Ä—á–º–∞–∞—Ä —Ö–∞—Ä–∂ –±–æ–ª–Ω–æ:\n"
            "‚Ä¢ DXY (–∞–º.–¥–æ–ª–ª–∞—Ä—ã–Ω –∏–Ω–¥–µ–∫—Å) stronger –±–∞–π–≤–∞–ª risk-off, gold/fx cross-–¥ –¥–∞—Ä–∞–º—Ç ”©–≥–Ω”©.\n"
            "‚Ä¢ –ì–æ–ª —Ç”©–≤ –±–∞–Ω–∫—É—É–¥—ã–Ω –±–æ–¥–ª–æ–≥—ã–Ω —Ö“Ø“Ø, –∏–Ω—Ñ–ª—è—Ü–∏–π–Ω —á–∏–≥ —Ö–∞–Ω–¥–ª–∞–≥—ã–≥ –∞–∂–∏–≥–ª–∞—Ö\n"
            "‚Ä¢ US, Eurozone, UK, Japan-–∏–π–Ω ”©–Ω–¥”©—Ä –Ω”©–ª”©”©—Ç—ç–π –º—ç–¥—ç—ç–Ω“Ø“Ø–¥–∏–π–Ω ”©–º–Ω”© —à–∏–Ω—ç –ø–æ–∑–∏—Ü–∏ –Ω—ç—ç—Ö—ç—ç—Å –∑–∞–π–ª—Å—Ö–∏–π—Ö\n\n"
            "–ò—Ä—ç—ç–¥“Ø–π–¥ investing.com —ç—Å–≤—ç–ª –±—É—Å–∞–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä —Å–∞–π—Ç–Ω–∞–∞—Å scrape —Ö–∏–π–∂,\n"
            "–∂–∏–Ω—Ö—ç–Ω—ç –º—ç–¥—ç—ç–Ω –¥—ç—ç—Ä —Ç—É–ª–≥—É—É—Ä–ª–∞—Å–∞–Ω –∞–≤—Ç–æ–º–∞—Ç —Ç–æ–π–º –≥–∞—Ä–≥–∞—Ö–∞–∞—Ä ”©—Ä–≥”©–∂“Ø“Ø–ª–Ω—ç."
        )

    # OpenAI –∞—à–∏–≥–ª–∞–Ω –µ—Ä”©–Ω—Ö–∏–π –º–∞–∫—Ä–æ —Ç–æ–π–º –º–æ–Ω–≥–æ–ª–æ–æ—Ä –∞–≤—á –±–∞–π–Ω–∞
    prompt = (
        "–§–æ—Ä–µ–∫—Å –∑–∞—Ö –∑—ç—ç–ª –¥—ç—ç—Ä –≥–æ–ª –≤–∞–ª—é—Ç—É—É–¥ (USD, EUR, GBP, JPY, XAUUSD) "
        "—è–º–∞—Ä –µ—Ä”©–Ω—Ö–∏–π –º–∞–∫—Ä–æ –Ω”©—Ö—Ü”©–ª–¥ –±–∞–π–∂ –±–æ–ª–æ—Ö —Ç–∞–ª–∞–∞—Ä TODAY –æ–≥–Ω–æ–æ–Ω—ã —Ö—É–≤—å–¥ "
        "–µ—Ä”©–Ω—Ö–∏–π —á–∏–≥ —Ö–∞–Ω–¥–ª–∞–≥—ã–≥ —Ç–∞–π–ª–±–∞—Ä–ª–∞. \n\n"
        "–ú—ç–¥—ç—ç–ª—ç–ª –Ω—å real-time –±–∞–π—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π, —Ö–∞—Ä–∏–Ω –≥–æ–ª –Ω”©–ª”©”©–ª”©–≥—á —Ö“Ø—á–∏–Ω –∑“Ø–π–ª“Ø“Ø–¥ "
        "—è–º–∞—Ä –±–∞–π–¥–∞–≥, —Ç—ç–¥–≥—ç—ç—Ä –Ω—å —Ö–∞–Ω—à–∏–¥ —è–∞–∂ –Ω”©–ª”©”©–ª–¥”©–≥ —Ç–∞–ª–∞–∞—Ä –æ–π–ª–≥–æ–º–∂—Ç–æ–π, "
        "–∞—Ö—ã–Ω –∑”©–≤–ª”©–≥”©”© –º–∞—è–≥–∞–∞—Ä, –º–æ–Ω–≥–æ–ª —Ö—ç–ª—ç—ç—Ä —Ç–∞–π–ª–±–∞—Ä–ª–∞. –ë—É–ª–ª–µ—Ç –∂–∞–≥—Å–∞–∞–ª—Ç, "
        "–±–æ–≥–∏–Ω–æ –¥–æ–≥–æ–ª –º”©—Ä“Ø“Ø–¥—Ç—ç–π –±–∞–π–≤–∞–ª —Å–∞–π–Ω."
    )

    try:
        from openai import OpenAI  # type: ignore

        client = OpenAI(api_key=api_key)
        resp = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {
                    "role": "system",
                    "content": "–ß–∏ —Ñ–æ—Ä–µ–∫—Å –º–∞–∫—Ä–æ —ç–¥–∏–π–Ω –∑–∞—Å–≥–∏–π–Ω —Ç–æ–π–º –≥–∞—Ä–≥–∞–¥–∞–≥, –º–æ–Ω–≥–æ–ª —Ö—ç–ª—ç—ç—Ä —è—Ä—å–¥–∞–≥ —à–∏–Ω–∂—ç—ç—á.",
                },
                {"role": "user", "content": prompt},
            ],
            temperature=0.5,
        )
        content = resp.choices[0].message.content.strip()
        return f"üìä <b>–ó–∞—Ö –∑—ç—ç–ª–∏–π–Ω —Ç–æ–π–º</b>\n–û–≥–Ω–æ–æ: {today} (UTC)\n\n{content}"
    except Exception:
        return (
            "üìä <b>–ó–∞—Ö –∑—ç—ç–ª–∏–π–Ω —Ç–æ–≤—á —Ç–æ–π–º</b>\n\n"
            "OpenAI –±–æ–ª–æ–º–∂–≥“Ø–π (OPENAI_UNAVAILABLE)\n\n"
            "–û–¥–æ–æ–≥–æ–æ—Ä demo —Ç–µ–∫—Å—Ç –∞—à–∏–≥–ª–∞–Ω–∞:\n"
            "‚Ä¢ –ì–æ–ª –≤–∞–ª—é—Ç—É—É–¥—ã–Ω —á–∏–≥–ª—ç–ª–∏–π–≥ DXY, —Ç”©–≤ –±–∞–Ω–∫–Ω—ã –±–æ–¥–ª–æ–≥–æ, –∏–Ω—Ñ–ª—è—Ü, "
            "risk-on/risk-off —Å—ç—Ç–≥—ç–ª –∑“Ø–π —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–¥–æ–≥.\n"
        )
